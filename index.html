
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IOE Web Auto</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    input, button { padding: 8px; margin: 4px 0; }
    #log { white-space: pre-wrap; background: #111; color: #eee; padding: 12px; min-height: 160px; }
    .ok { color: #4ade80 }
    .warn { color: #facc15 }
    .err { color: #f87171 }
  </style>
</head>
<body>
  <h1>IOE Web Auto</h1>

  <label>Link làm bài IOE:</label>
  <input id="ioeLink" placeholder="https://ioe.vn/lam-bai/...&token=..." style="width:100%"/>

  <label>Delay hoàn thành (giây, ≥ 10):</label>
  <input id="delaySec" type="number" min="10" value="12" />

  <div>
    <button id="runBtn">Chạy</button>
  </div>

  <h3>Log</h3>
  <div id="log"></div>

<script>
const API_BASE = "http://localhost:3000/api"; // proxy của bạn
const logEl = document.getElementById('log');
function log(msg, cls="") { logEl.innerHTML += `<div class="${cls}">${msg}</div>`; logEl.scrollTop = logEl.scrollHeight; }
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

function parseTokenFromUrl(url) {
  try {
    const u = new URL(url);
    return u.searchParams.get('token');
  } catch (e) {
    return null;
  }
}

async function api(path, body) {
  const res = await fetch(`${API_BASE}${path}`, {
    method: 'POST', headers: { 'content-type': 'application/json' },
    body: JSON.stringify(body)
  });
  const text = await res.text();
  console.log('API', path, body, res.status, text);
  try { return JSON.parse(text); } catch { return { raw: text }; }
}

async function tryAnswer(tokenrq, examKey, questId, point, candidate) {
  const payload = {
    api_key: 'gameioe', serviceCode: 'IOE', token: tokenrq, examKey,
    ans: { questId, point, ans: candidate }, IPClient: '', deviceId: ''
  };
  console.log('tryAnswer', payload);
  const jr = await api('/answercheck', payload);
  const returnedPoint = jr?.data?.point ?? 0;
  return returnedPoint === point;
}

function buildArrangeSentence(q) { // type = 5
  const tokens = (q.ans || []).slice().sort((a,b) => (a.orderTrue||0)-(b.orderTrue||0)).map(a => a.content || "");
  return tokens.join(' ');
}

function buildPairingAnswer(q) { // type = 7
  const text = q?.content?.content || "";
  const imageUrl = (q.ans && q.ans[0]?.content) || "";
  return `${text}|${imageUrl}`;
}

function buildOrderPipe(q) { // ví dụ type = 3 (từ cho sẵn, ghép theo order)
  const tokens = (q.ans || []).slice().sort((a,b) => (a.orderTrue||0)-(b.orderTrue||0)).map(a => a.content || "");
  return tokens.filter(Boolean).join('|');
}

async function run() {
  logEl.innerHTML = '';
  const link = document.getElementById('ioeLink').value.trim();
  const delaySec = Math.max(10, parseInt(document.getElementById('delaySec').value, 10) || 10);

  const ioeToken = parseTokenFromUrl(link);
  if (!ioeToken) { log('Không tìm thấy token trong URL.', 'err'); return; }

  log('▶ getinfo...');
  const getinfo = await api('/getinfo', { IPClient: '', api_key: 'gameioe', deviceId: '', serviceCode: 'IOE', token: ioeToken });
  if (!getinfo?.IsSuccessed) { log('getinfo fail: ' + JSON.stringify(getinfo), 'err'); return; }

  const tokenrq = getinfo.data?.token;
  const examKey = getinfo.data?.game?.examKey;
  const questions = getinfo.data?.game?.question || [];
  if (!tokenrq || !examKey || questions.length === 0) { log('Thiếu token/examKey/question.', 'err'); return; }

  const type = questions[0]?.type;
  log(`Loại bài: ${type}`);

  log('▶ startgame...');
  const startRes = await api('/startgame', { api_key:'gameioe', serviceCode:'IOE', token: tokenrq, gameId: 0, examKey, deviceId:'', IPClient:'' });
  if (!startRes?.IsSuccessed) { log('startgame fail: ' + JSON.stringify(startRes), 'err'); return; }
  
  // Build ans[]
  const ans = [];
  const TF = ['True','False'];

  if (type === 5) {
    for (const q of questions) {
      const sentence = buildArrangeSentence(q);
      ans.push({ questId: q.id, ans: sentence, Point: q.Point });
    }
  } else if (type === 7) {
    for (const q of questions) {
      const a = buildPairingAnswer(q);
      ans.push({ questId: q.id, ans: a, Point: q.Point });
    }
  } else if (type === 3) {
    for (const q of questions) {
      const a = buildOrderPipe(q);
      ans.push({ questId: q.id, ans: a, Point: q.Point });
    }
  } else if (type === 10 || type === 1) {
    // trắc nghiệm / đúng-sai — thử bằng answercheck
    for (const q of questions) {
      const options = (q.ans||[]).map(x => x.content).filter(x => x != null);
      const candidates = (options.length === 0 || options.every(s => !s || !s.trim())) ? TF : options;
      let solved = false;
      for (const cand of candidates) {
        const ok = await tryAnswer(tokenrq, examKey, q.id, q.Point, cand);
        log(`  thử "${cand}" => ${ok ? 'ĐÚNG' : 'sai'}`);
        if (ok) { ans.push({ questId: q.id, ans: cand, Point: q.Point }); solved = true; break; }
        await sleep(120);
      }
      if (!solved) log(`  !! Chưa tìm được đáp án cho Q#${q.id}`, 'warn');
    }
  } else {
    log('Loại bài chưa hỗ trợ trong demo này.', 'warn');
  }

  // startgame -> chờ -> finishgame
  

  log(`⏳ chờ ${delaySec}s...`);
  await sleep(delaySec * 1000);

  log('▶ finishgame...');
  const finishPayload = { api_key:'gameioe', token: tokenrq, serviceCode:'IOE', examKey, ans, IPClient:'', deviceId:'' };
  const fin = await api('/finishgame', finishPayload);
  log('Kết quả: ' + JSON.stringify(fin));
  log('XONG', 'ok');
}

document.getElementById('runBtn').addEventListener('click', run);
</script>
</body>
</html>